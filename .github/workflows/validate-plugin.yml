name: Validate Plugin

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  validate:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Validate plugin.json
        run: |
          echo "Validating plugin.json syntax..."
          node -e "JSON.parse(require('fs').readFileSync('.claude-plugin/plugin.json', 'utf8')); console.log('✅ plugin.json is valid JSON')"
      
      - name: Run plugin validation script
        run: |
          echo "Running comprehensive plugin validation..."
          node scripts/validate-plugin.js
      
      - name: Check for Cyrillic characters
        run: |
          echo "Checking for Cyrillic characters..."
          if grep -r --include="*.md" --include="*.json" --include="*.js" --include="*.ts" --include="*.yml" --include="*.yaml" '[А-Яа-яЁё]' . 2>/dev/null | grep -v node_modules | grep -v ".git"; then
            echo "⚠️  Warning: Cyrillic characters found in files"
            echo "This is a warning, not blocking the build"
          else
            echo "✅ No Cyrillic characters found"
          fi
      
      - name: Verify all skills exist
        run: |
          echo "Verifying all skills have SKILL.md files..."
          for skill in skills/*/; do
            if [ ! -f "${skill}SKILL.md" ]; then
              echo "❌ Missing SKILL.md in ${skill}"
              exit 1
            fi
            echo "✅ Found SKILL.md in ${skill}"
          done
      
      - name: Check YAML frontmatter in skills
        run: |
          echo "Checking YAML frontmatter in all skills..."
          for skill in skills/*/SKILL.md; do
            if ! head -n 1 "$skill" | grep -q "^---$"; then
              echo "❌ Missing YAML frontmatter in $skill"
              exit 1
            fi
            echo "✅ YAML frontmatter found in $skill"
          done
      
      - name: Validate directory structure
        run: |
          echo "Validating directory structure..."
          required_dirs=(".claude-plugin" "skills" "templates" "hooks" "scripts" "config")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "❌ Missing required directory: $dir"
              exit 1
            fi
            echo "✅ Directory exists: $dir"
          done
      
      - name: Check required files
        run: |
          echo "Checking required files..."
          required_files=("README.md" "LICENSE" ".gitignore" ".claude-plugin/plugin.json")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✅ File exists: $file"
          done
      
      - name: Validation summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🎉 Plugin Validation Successful!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "✅ All validation checks passed"
          echo "✅ Plugin structure is valid"
          echo "✅ Ready for deployment"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
